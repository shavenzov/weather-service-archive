!function(t){var e={};function n(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(i,a,function(e){return t[e]}.bind(null,a));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=7)}([function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e){function n(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}t.exports=function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}},function(t,e,n){var i=n(6);t.exports=function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},a=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),a.forEach(function(e){i(t,e,n[e])})}return t}},function(t,e,n){t.exports=function(){return new Worker(n.p+"269c469c5c1e64b11c91.worker.js")}},function(t,e,n){},,function(t,e){t.exports=function(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}},function(t,e,n){"use strict";n.r(e);n(4);var i=n(0),a=n.n(i),r=n(1),o=n.n(r),s=n(3),h=n.n(s),l=function(){function t(e){var n=this;a()(this,t),this.labelFontSize=16,this.fontSetings="".concat(16,"px Roboto"),this.axisStrokeStyle="grey",this.graphStrokeStyle="grey",this.fromDate=null,this.toDate=null,this.graphWorker=null,this._data=null,this.meanMinValue=null,this.meanMaxValue=null,this.minValue=null,this.maxValue=null,this.drawFn=function(t){return n.draw(t)},this.canvas=document.getElementById(e),this.ctx=this.canvas.getContext("2d"),this.tid=-1,window.addEventListener("resize",function(){-1!==n.tid&&(clearTimeout(n.tid),n.tid=-1),n.tid=setTimeout(function(){n.tid=-1,n.redraw()},200),n.updateCanvasSize()}),this.updateCanvasSize()}return o()(t,[{key:"startWorker",value:function(){this._data&&(this.graphWorker=new h.a,this.graphWorker.postMessage({graphWidth:this.width,meanMinValue:this.meanMinValue,meanMaxValue:this.meanMaxValue,data:this._data}),this.graphWorker.addEventListener("message",this.drawFn))}},{key:"stopWorker",value:function(){this.graphWorker&&(this.graphWorker.removeEventListener("message",this.drawFn),this.graphWorker.terminate())}},{key:"updateCanvasSize",value:function(){var t=this.canvas.parentNode,e=window.getComputedStyle(t),n=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),i=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom),a=parseFloat(e.borderLeftWidth)+parseFloat(e.borderRightWidth),r=parseFloat(e.borderTopWidth)+parseFloat(e.borderBottomWidth);this.canvas.width=t.offsetWidth-n-a,this.canvas.height=t.offsetHeight-i-r}},{key:"redraw",value:function(){this.stopWorker(),this.startWorker(),console.log("redraw",this.width,this.height)}},{key:"draw",value:function(t){var e=this,n=t.data,i=n.type,a=n.meanMinValue,r=n.meanMaxValue,o=n.minValue,s=n.maxValue,h=n.drawInfo;"done"===i&&(this.graphWorker.removeEventListener("message",this.drawFn),this.graphWorker=null,this.meanMinValue=a,this.meanMaxValue=r,this.minValue=o,this.maxValue=s,this.ctx.clearRect(0,0,this.width,this.height),this.drawAxes(h),this.ctx.lineWidth=2,this.ctx.strokeStyle=this.graphStrokeStyle,this.ctx.beginPath(),h.forEach(function(t){0===t.graphX&&e.ctx.moveTo(t.graphX,e.calcY(t.v)),e.ctx.lineTo(t.graphX,e.calcY(t.v))}),this.ctx.stroke())}},{key:"calcY",value:function(t){var e=this.meanMinValue<0&&this.meanMaxValue>0?this.height/2:this.height,n=Math.max(Math.abs(this.meanMinValue),Math.abs(this.meanMaxValue));return t>0?e-t*e/n:e+Math.abs(t)*e/n}},{key:"drawAxes",value:function(){if(this.ctx.lineWidth=1,this.ctx.strokeStyle=this.axisStrokeStyle,this.ctx.font=this.fontSetings,this.meanMinValue>=0&&this.meanMaxValue>0){this.ctx.beginPath(),this.ctx.moveTo(0,this.height),this.ctx.lineTo(this.width,this.height),this.ctx.moveTo(0,this.height),this.ctx.lineTo(0,0),this.ctx.stroke(),this.ctx.fillText(this.formatValue(this.maxValue),8,this.labelFontSize);var t=this.formatDate(this.fromDate)+" - "+this.formatDate(this.toDate),e=this.ctx.measureText(t);this.ctx.fillText(t,this.width-e.width-8,this.labelFontSize)}else if(this.meanMinValue<0&&this.meanMaxValue<=0){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(0,this.height),this.ctx.moveTo(0,this.height),this.ctx.lineTo(0,0),this.ctx.stroke(),this.ctx.fillText(this.formatValue(this.minValue),8,this.height);var n=this.formatDate(this.fromDate)+" - "+this.formatDate(this.toDate),i=this.ctx.measureText(n);this.ctx.fillText(n,this.width-i.width-8,this.height-2)}else if(this.meanMinValue<0&&this.meanMaxValue>0){var a=this.height/2;this.ctx.beginPath(),this.ctx.moveTo(0,a),this.ctx.lineTo(this.width,a),this.ctx.moveTo(0,this.height),this.ctx.lineTo(0,0),this.ctx.stroke(),this.ctx.fillText(this.formatValue(this.maxValue),8,this.labelFontSize),this.ctx.fillText(this.formatValue(this.minValue),8,this.height);var r=this.formatDate(this.fromDate)+" - "+this.formatDate(this.toDate),o=this.ctx.measureText(r);this.ctx.fillText(r,this.width-o.width-8,this.height-2)}}},{key:"formatValue",value:function(t){var e=t.toFixed(2),n=e.split("."),i=n[0],a=n[1];return"0"===a[0]&&"0"===a[1]?i:"0"===a[1]?"".concat(i,".").concat(a[0]):e}},{key:"formatDate",value:function(t){var e=t.getDate();e<10&&(e="0".concat(e));var n=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"][t.getMonth()],i=t.getFullYear();return"".concat(e," ").concat(n,". ").concat(i," г.")}},{key:"data",get:function(){return this._data},set:function(t){this._data=t,this.meanMinValue=null,this.meanMaxValue=null,this.minValue=null,this.maxValue=null,this.fromDate=t[0].t,this.toDate=t[t.length-1].t,this.redraw()}},{key:"isRedrawing",get:function(){return null!==this.graphWorker}},{key:"width",get:function(){return this.canvas.width}},{key:"height",get:function(){return this.canvas.height}}]),t}(),u=function(){function t(e){var n=this;a()(this,t),this.container=document.getElementById(e);var i=this.container.getElementsByTagName("select");this.fromUILIst=i[0],this.fromUILIst.addEventListener("change",function(t){return n.onSelectedIntervalChanged(t)}),this.toUIList=i[1],this.toUIList.addEventListener("change",function(t){return n.onSelectedIntervalChanged(t)}),this.interval=null,this.fromDate=null,this.toDate=null,this.onintervalchanged=null}return o()(t,[{key:"onSelectedIntervalChanged",value:function(t){var e=t.currentTarget,n=new Date(parseInt(e.options[e.selectedIndex].value));if(e===this.fromUILIst?this.fromDate=n:e===this.toUIList&&(this.toDate=n),this.fromDate.getTime()>this.toDate.getTime()){var i=[this.toDate,this.fromDate];this.fromDate=i[0],this.toDate=i[1]}this.updateSelection(),this.onintervalchanged&&this.onintervalchanged({fromDate:this.fromDate,toDate:this.toDate})}},{key:"updateSelection",value:function(){for(var t=this.fromDate.getTime().toString(),e=this.toDate.getTime().toString(),n=0;n<this.fromUILIst.options.length;n++){var i=this.fromUILIst.options[n];i.selected=t===i.value,i.disabled=e===i.value,(i=this.toUIList.options[n]).selected=e===i.value,i.disabled=t===i.value}}},{key:"populateOptions",value:function(){for(;this.fromUILIst.firstChild;)this.fromUILIst.removeChild(this.fromUILIst.firstChild);for(;this.toUIList.firstChild;)this.toUIList.removeChild(this.toUIList.firstChild);if(this.interval&&this.interval.length>0){this.fromDate=this.interval[0].value,this.toDate=this.interval[this.interval.length-1].value;for(var t=0;t<this.interval.length;t++){var e=this.interval[t],n=0===t,i=t===this.interval.length-1,a=document.createElement("option");a.textContent=e.label,a.value=e.value.getTime(),a.selected=n,a.disabled=i;var r=a.cloneNode(!0);r.selected=i,r.disabled=n,this.fromUILIst.appendChild(a),this.toUIList.appendChild(r)}}}},{key:"setData",value:function(t){var e=this;if(this.fromDate=null,this.toDate=null,t&&t.length>0){var n=t[0].t.getFullYear();this.interval=[{label:n,value:t[0].t}],t.forEach(function(t){var i=t.t.getFullYear();i!==n&&(e.interval.push({label:i,value:t.t}),n=i)});var i=this.interval[this.interval.length-1].label+1;this.interval.push({label:i,value:new Date(i,0,1)})}else this.interval=null;this.populateOptions()}}]),t}(),c=function(){function t(e){var n=this;a()(this,t),this.SELECTED_CLASS_NAME="selected",this.container=document.getElementById(e),this.buttons=this.container.getElementsByTagName("button"),this._selectedId=this.buttons[0].dataset.id,this.setSelection(this._selectedId);for(var i=0;i<this.buttons.length;i++)this.buttons[i].addEventListener("click",function(t){return n.onButtonClick(t)});this.onchange=null}return o()(t,[{key:"setSelection",value:function(t){for(var e=0;e<this.buttons.length;e++){var n=this.buttons[e],i=t===n.dataset.id,a=n.className.split(" "),r=a.indexOf(this.SELECTED_CLASS_NAME);-1!==r&&a.splice(r,1),i&&a.push(this.SELECTED_CLASS_NAME),n.className=a.join(" ")}}},{key:"onButtonClick",value:function(t){this.selectedId=t.target.dataset.id}},{key:"selectedId",get:function(){return this._selectedId},set:function(t){this._selectedId!==t&&(this._selectedId=t,this.setSelection(t),this.onchange&&this.onchange(this._selectedId))}}]),t}(),d=n(2),f=n.n(d),v=function(){function t(){a()(this,t)}return o()(t,null,[{key:"deserialize",value:function(t){return new Date(t)}},{key:"serialize",value:function(e){var n=e.getDate();return n<10&&(n="0".concat(n)),"".concat(t.serializeYearMonth(e),"-").concat(n)}},{key:"serializeYearMonth",value:function(t){var e=t.getMonth()+1;return e<10&&(e="0".concat(e)),"".concat(t.getFullYear(),"-").concat(e)}}]),t}(),g=function(){function t(){a()(this,t),this.DB_NAME="weather",this.TEMPERATURE_STORE="temperature",this.PRECIPITATION_STORE="precipitation",this.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB}return o()(t,[{key:"open",value:function(){var t=this;return new Promise(function(e,n){var i=t.indexedDB.open(t.DB_NAME,1);i.onupgradeneeded=function(){i.result.createObjectStore(t.TEMPERATURE_STORE,{keyPath:"time"}),i.result.createObjectStore(t.PRECIPITATION_STORE,{keyPath:"time"})},i.onsuccess=function(){e(i.result)},i.onerror=function(){n(i.error)}})}},{key:"addTemperature",value:function(t){return this.addData(this.TEMPERATURE_STORE,t)}},{key:"addPrecipitation",value:function(t){return this.addData(this.PRECIPITATION_STORE,t)}},{key:"addData",value:function(t,e){var n=this;return new Promise(function(i,a){n.open().then(function(n){for(var r=n.transaction(t,"readwrite"),o=r.objectStore(t),s=v.serializeYearMonth(e[0].t),h=e[0].t,l=[],u=0;u<e.length;u++){var c=e[u],d=v.serializeYearMonth(c.t);s===d?l.push(f()({},c,{t:v.serialize(c.t)})):(l.length>0&&o.add({time:h.getTime(),data:l}),l=[f()({},c,{t:v.serialize(c.t)})],s=d,h=c.t)}l.length>0&&o.add({time:h.getTime(),data:l}),r.oncomplete=function(){console.log("complete"),i()},r.onabort=function(){a(r.error)},r.onerror=function(){a(r.error)}}).catch(function(t){a(t)})}).catch(function(t){return reject(db.error)})}},{key:"getPrecipitation",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.getData(this.PRECIPITATION_STORE,t,e)}},{key:"getTemperature",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.getData(this.TEMPERATURE_STORE,t,e)}},{key:"getData",value:function(t,e,n){var i=this;return new Promise(function(a,r){i.open().then(function(i){var o=i.transaction(t,"readonly"),s=o.objectStore(t),h=[],l=null;e&&n?l=IDBKeyRange.bound(e.getTime(),n.getTime(),!1,!0):e?l=IDBKeyRange.lowerBound(e.getTime()):n&&(l=IDBKeyRange.upperBound(n.getTime(),!0));var u=s.openCursor(l);u.onsuccess=function(){var t=u.result;t&&(h.push(t.value),t.continue())},o.oncomplete=function(){h=h.reduce(function(t,e){return t.concat(e.data.map(function(t){return f()({},t,{t:v.deserialize(t.t)})}))},[]),console.log("complete"),a(h)},o.onabort=function(){r(o.error)},o.onerror=function(){r(o.error)}}).catch(function(t){return r(db.error)})})}},{key:"clearAll",value:function(){var t=this;return new Promise(function(e,n){var i=t.indexedDB.deleteDatabase(t.DB_NAME);i.onerror=function(){n(i.error)},i.onsuccess=function(t){e()}})}},{key:"isSupported",get:function(){return null!=this.indexedDB}}]),t}(),m=function(){function t(){a()(this,t)}return o()(t,null,[{key:"onInterval",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return null==e&&null==n?t.slice():t.filter(function(t){var i=!e||t.t.getTime()>=e.getTime(),a=!n||t.t.getTime()<n.getTime();return i&&a})}}]),t}(),p=function(){function t(){a()(this,t),this.TEMPERATURE_ENDPOINT="data/temperature.json",this.PRECIPITATION_ENDPOINT="data/precipitation.json"}return o()(t,[{key:"dataTransform",value:function(t){return f()({},t,{t:v.deserialize(t.t)})}},{key:"getPrecipitation",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=fetch(this.PRECIPITATION_ENDPOINT).then(function(t){return t.json()}).then(function(e){return e.map(function(e){return t.dataTransform(e)})});return e||n?i.then(function(t){return m.onInterval(t,e,n)}):i}},{key:"getTemperature",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=fetch(this.TEMPERATURE_ENDPOINT).then(function(t){return t.json()}).then(function(e){return e.map(function(e){return t.dataTransform(e)})});return e||n?i.then(function(t){return m.onInterval(t,e,n)}):i}}]),t}(),T=function(){function t(){a()(this,t),this.localSource=new g,this.remoteSource=new p,this.temperature=null,this.precipitation=null}return o()(t,[{key:"getPrecipitation",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new Promise(function(i,a){if(t.precipitation)i({data:m.onInterval(t.precipitation,e,n),fromCache:!0,caching:null});else{var r=function(a){null==e&&null==n&&(t.precipitation=a.data.slice()),i(a)};t.localSource.isSupported?t.localSource.getPrecipitation(e,n).then(function(t){if(!(t.length>0))throw new Error("Local source is empty.");r({data:t,fromCache:!0,caching:null})}).catch(function(i){t.remoteSource.getPrecipitation(e,n).then(function(e){var n=t.localSource.addPrecipitation(e);r({data:e,fromCache:!1,caching:n})}).catch(function(t){return a(t)})}):t.remoteSource.getPrecipitation(e,n).then(function(t){r({data:t,fromCache:!1,caching:null})}).catch(function(t){return a(t)})}})}},{key:"getTemperature",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new Promise(function(i,a){if(t.temperature)i({data:m.onInterval(t.temperature,e,n),fromCache:!0,caching:null});else{var r=function(a){null==e&&null==n&&(t.temperature=a.data.slice()),i(a)};t.localSource.isSupported&&t.localSource.getTemperature(e,n).then(function(t){if(!(t.length>0))throw new Error("Local source is empty.");r({data:t,fromCache:!0,caching:null})}).catch(function(i){t.remoteSource.getTemperature(e,n).then(function(e){var n=t.localSource.addTemperature(e);r({data:e,fromCache:!1,caching:n})}).catch(function(t){return a(t)})}),t.remoteSource.getTemperature(e,n).then(function(t){r({data:t,fromCache:!1,caching:null})}).catch(function(t){return a(t)})}})}}]),t}();new(function(){function t(){var e=this;a()(this,t),this.dataSource=new T,this.graph=new l("graph"),this.aside=new c("aside"),this.aside.onchange=function(t){return e.asideOnChange(t)},this.navigation=new u("navigation"),this.navigation.onintervalchanged=function(t){return e.navigationIntervalChanged(t)},this.loadData()}return o()(t,[{key:"navigationIntervalChanged",value:function(t){this.loadData(this.aside.selectedId,t.fromDate,t.toDate)}},{key:"asideOnChange",value:function(t){this.loadData(t)}},{key:"loadData",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"temperature",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;("temperature"===e?this.dataSource.getTemperature:this.dataSource.getPrecipitation).call(this.dataSource,n,i).then(function(e){var a=e.data;e.fromCache,e.caching;t.graph.data=a,null==n&&null==i&&t.navigation.setData(a)}).catch(function(t){return console.log("error",t)})}}]),t}())}]);